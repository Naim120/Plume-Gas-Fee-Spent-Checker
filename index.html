<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plume Gas Fee Tracker</title>
  <style>
    :root {
      --bg: #0b0c10;
      --card: #12151b;
      --muted: #a0a6b8;
      --text: #e8ecf1;
      --accent: #7c5cff;
      --accent-2: #00d4ff;
      --danger: #ff6b6b;
      --ok: #10b981;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, rgba(124,92,255,0.12), transparent 60%),
                  radial-gradient(800px 600px at 120% 10%, rgba(0,212,255,0.12), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height: 100dvh;
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 28px 16px 64px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }
    h1 {
      font-size: 24px;
      margin: 0;
      letter-spacing: 0.2px;
    }
    .card {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.18); 
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 6px 28px rgba(0,0,0,0.25);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 720px) {
      .grid { grid-template-columns: 1.5fr 1fr; }
    }
    label { font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="text"], input[type="date"], input[type="number"] {
      width: 100%;
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 10px;
      outline: none;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      opacity: 0.9;
    }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btns { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    button {
      border: none; outline: none; cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #060608; font-weight: 700; letter-spacing: 0.2px;
      padding: 12px 16px; border-radius: 10px; transition: transform .04s ease;
    }
    button.secondary { background: transparent; color: var(--text); border: 1px solid rgba(255,255,255,0.12); }
    button:active { transform: translateY(1px); }
    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .summary {
      display: grid; gap: 10px; grid-template-columns: 1fr; margin-top: 14px;
    }
    @media (min-width: 720px) {
      .summary { grid-template-columns: repeat(4, 1fr); }
    }
    .kpi { background: var(--card); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 12px; }
    .kpi h3 { margin: 0; font-size: 12px; color: var(--muted); font-weight: 600; }
    .kpi .v { font-size: 20px; margin-top: 4px; font-weight: 800; }
    .status { margin-top: 12px; font-size: 14px; color: var(--muted); }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--danger); }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 13px; }
    th { color: var(--muted); font-weight: 600; }
    .mono { font-family: ui-monospace, Menlo, Consolas, "SFMono-Regular", monospace; }
    .link { color: #8fd3ff; text-decoration: none; }
    .link:hover { text-decoration: underline; }
    footer { margin-top: 28px; font-size: 12px; color: var(--muted); text-align: center; }
    .goon-wrap { display: flex; justify-content: center; margin: 24px 0 32px; }
    .goon-wrap img { max-width: 140px; height: 120px; opacity: 0.95; }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Plume Gas Fee Tracker</h1>
      <div class="hint">Powered by explorer.plume.org API</div>
    </header>

    <div class="card grid" id="formCard">
      <div>
        <label for="address">Wallet Address</label>
        <input id="address" type="text" placeholder="0x…" value="" />
        <div class="hint">Must be a valid EVM address (0x + 40 hex chars).</div>
      </div>
      <div>
        <div class="row">
          <div>
            <label for="start">Start Date (UTC)</label>
            <input id="start" type="date" />
          </div>
          <div>
            <label for="end">End Date (UTC)</label>
            <input id="end" type="date" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label for="pages">Max Pages</label>
            <input id="pages" type="number" min="1" max="100" step="1" value="10" />
            <div class="hint">Each page ≈ 50 txs. Increase if you have heavy activity.</div>
          </div>
          <div>
            <label for="limit">Page Size</label>
            <input id="limit" type="number" min="10" max="100" step="10" value="50" />
            <div class="hint">Most Blockscout APIs support up to 100.</div>
          </div>
        </div>
        <div class="btns">
          <button id="runBtn">Calculate Gas</button>
          <button id="csvBtn" class="secondary" disabled>Download CSV</button>
        </div>
      </div>
    </div>

    <div class="summary" id="summary" style="display:none">
      <div class="kpi"><h3>Total Gas (wei)</h3><div class="v mono" id="weiOut">—</div></div>
      <div class="kpi"><h3>Total Gas (PLUME)</h3><div class="v mono" id="plumeOut">—</div></div>
      <div class="kpi"><h3>Approx. USD</h3><div class="v mono" id="usdOut">—</div><div class="hint">exchange rate may vary.</div></div>
      <div class="kpi"><h3>Tx Count (in range)</h3><div class="v mono" id="countOut">—</div></div>
    </div>

    <div id="status" class="status">Fill the form and click <b>Calculate Gas</b>.</div>

    <div class="card" id="tableCard" style="display:none">
      <table>
        <thead>
          <tr>
            <th>Time (UTC)</th>
            <th>Hash</th>
            <th>To</th>
            <th>Method</th>
            <th class="mono">Fee (PLUME)</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
<div class="goon-wrap">
  <img src="goon1.png" alt="goon" />
</div>


    <footer>
      Built for Plume - by x.com/ghostriley68721
    </footer>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const API_BASE = "https://plume.skdrive.workers.dev";

  const el = (id) => document.getElementById(id);
  const runBtn = el('runBtn');
  const csvBtn = el('csvBtn');

  function isValidAddress(addr) { return /^0x[a-fA-F0-9]{40}$/.test(addr); }
  function toUTCStart(dateStr){ return new Date(dateStr + 'T00:00:00.000Z'); }
  function toUTCEnd(dateStr){ return new Date(dateStr + 'T23:59:59.999Z'); }
  function parseApiTimestamp(ts){
    if (typeof ts === 'number') return new Date(ts * 1000);
    if (/Z$/.test(ts)) return new Date(ts);
    return new Date(ts + 'Z');
  }
  function formatPLUMEFromWeiStr(weiStr){
    try {
      const wei = BigInt(weiStr);
      const whole = wei / 10n**18n;
      const frac = (wei % 10n**18n).toString().padStart(18, '0').replace(/0+$/, '');
      return frac ? `${whole}.${frac}` : `${whole}`;
    } catch { return '0'; }
  }

  async function fetchPage(address, cursorParams, limit=50) {
    let url = `${API_BASE}/addresses/${address}/transactions?limit=${limit}`;
    if (cursorParams) {
      const params = new URLSearchParams(cursorParams).toString();
      url += '&' + params;
    }
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }

  function buildCsv(rows){
    const header = ['time_utc','hash','to','method','fee_plume','fee_wei','exchange_rate_usd','fee_usd_est'];
    const lines = [header.join(',')];
    for (const r of rows){
      const cells = [r.time,r.hash,r.to,r.method,r.fee_plume,r.fee_wei,r.exchange_rate ?? '',r.fee_usd_est ?? ''];
      lines.push(cells.map(v => typeof v==='string'&&v.includes(',')?'"'+v.replaceAll('"','""')+'"':v).join(','));
    }
    return lines.join('\n');
  }

  runBtn.addEventListener('click', async () => {
    const address = el('address').value.trim();
    const startStr = el('start').value;
    const endStr = el('end').value;
    const limit = Math.max(10, Math.min(100, parseInt(el('limit').value||'50',10)));
    const status = el('status');
    const rowsTbody = el('rows');
    const summary = el('summary');
    const tableCard = el('tableCard');
    rowsTbody.innerHTML = '';
    summary.style.display = 'none';
    tableCard.style.display = 'none';
    csvBtn.disabled = true;

    if (!isValidAddress(address)) {
      status.className = 'status err';
      status.innerHTML = '✖ Enter a valid EVM address (0x + 40 hex chars).';
      return;
    }
    if (!startStr || !endStr) {
      status.className = 'status err';
      status.innerHTML = '✖ Select both start and end dates.';
      return;
    }

    const start = toUTCStart(startStr);
    const end = toUTCEnd(endStr);
    if (end < start) {
      status.className = 'status err';
      status.innerHTML = '✖ End date must be on/after start date.';
      return;
    }

    status.className = 'status';
    status.innerHTML = '⏳ Fetching transactions…';

    let cursorParams = null;
    let collected = [];
    let seenInRange = false;

    try {
      while (true) {
        status.innerHTML = `⏳ Fetching page ${Math.floor(collected.length/limit)+1}…`;
        const data = await fetchPage(address, cursorParams, limit);
        const items = data.items || [];
        if (!items.length) break;

        const times = items.map(tx => parseApiTimestamp(tx.timestamp)).filter(d=>!isNaN(d.getTime()));
        if (!times.length) break;

        const pageMin = new Date(Math.min(...times.map(d=>d.getTime())));
        const pageMax = new Date(Math.max(...times.map(d=>d.getTime())));
        const isDesc = times[0] > times[times.length-1];
        if (isDesc && pageMax < start) break;
        if (!isDesc && pageMin > end) break;

        for (const tx of items) {
          const ts = parseApiTimestamp(tx.timestamp);
          if (isNaN(ts.getTime())) continue;
          if (ts>=start && ts<=end) {
            seenInRange = true;
            const feeWeiStr = tx.fee?.value ?? ((tx.gas_used&&tx.gas_price)?(BigInt(tx.gas_used)*BigInt(tx.gas_price)).toString():'0');
            const feePlume = formatPLUMEFromWeiStr(feeWeiStr);
            const exr = tx.exchange_rate ? Number(tx.exchange_rate) : null;
            const feeUsd = exr ? (Number((BigInt(feeWeiStr)/10n**12n))/1e6)*exr : null;
            collected.push({
              time: ts.toISOString().replace('.000Z','Z'),
              hash: tx.hash,
              to: tx.to?.hash ?? '',
              method: tx.method||'',
              fee_wei: feeWeiStr,
              fee_plume: feePlume,
              exchange_rate: exr,
              fee_usd_est: feeUsd ? feeUsd.toFixed(6) : undefined
            });
          }
        }

        cursorParams = data.next_page_params ?? null;
        if (!cursorParams) break;
      }
    } catch(err){
      console.error(err);
      status.className = 'status err';
      status.innerHTML = `✖ Error: ${err.message}. If this is a CORS issue, place this behind a Cloudflare Worker proxy.`;
    }
  });

  // prefill address & dates from URL
  (function initFromQuery(){
    const q = new URLSearchParams(location.search);
    const addr = q.get('address');
    const start = q.get('start');
    const end = q.get('end');
    if (addr) el('address').value = addr;
    if (start) el('start').value = start;
    if (end) el('end').value = end;
  })();

});
</script>


</body>
</html>
